# Makerspace Partheland - Sensordaten API

Diese Dokumentation beschreibt, wie Sie die Sensordaten des Makerspace Partheland in Ihre eigenen Anwendungen einbinden k√∂nnen.

## Inhaltsverzeichnis
- [√úbersicht](#√ºbersicht)
- [Verf√ºgbare Daten](#verf√ºgbare-daten)
- [Zugriffsm√∂glichkeiten](#zugriffsm√∂glichkeiten)
- [Anwendungsbeispiele](#anwendungsbeispiele)
- [Anwendungsideen f√ºr Wasserstandsdaten](#anwendungsideen-f√ºr-wasserstandsdaten)
- [Technische Details](#technische-details)

## √úbersicht

Der Makerspace Partheland stellt Umwelt- und Sensordaten √∂ffentlich zur Verf√ºgung. Diese Daten k√∂nnen Sie f√ºr verschiedene Zwecke nutzen:
- üè† Smart Home Automation
- üè´ Bildungsprojekte
- ÔøΩÔøΩ Umweltmonitoring
- üíß Gew√§sser√ºberwachung
- üìä Datenanalyse

## Verf√ºgbare Daten

### SenseBox Messstationen
Unsere SenseBox:home Stationen messen:
- üå°Ô∏è Temperatur (in ¬∞C)
- üíß Luftfeuchtigkeit (in %)
- üìä Luftdruck (in hPa)
- üí® Feinstaub (PM10 und PM2.5)
- üîÜ UV-Intensit√§t
- üí° Beleuchtungsst√§rke
- üîä Lautst√§rke (in dB)

### Wasserstandssensoren
Die Wasserstandssensoren erfassen:
- üíß Wasserstand (in cm)
- üìä Pegeltrends
- üîã Batteriestatus
- üìè Messdistanz

## Zugriffsm√∂glichkeiten

### 1. Echtzeit-Updates via MQTT (WebSocket)
Ideal f√ºr:
- Smart Home Systeme (Home Assistant, ioBroker, etc.)
- Live-Anzeigen
- Automatisierungen

**Verbindungsdaten:**
```
URL: wss://mqtt.makerspace-partheland.de:443/mqtt
```

**Topics f√ºr SenseBox Daten:**
```
senseBox:home/Beucha_Nr1
```

Beispiel-Nachricht:
```json
{
  "fields": {
    "Temperatur": 7.9,
    "Luftfeuchte": 84.3,
    "Luftdruck": 995.2,
    "PM10": 38.2,
    "PM2.5": 17.9,
    "UV-Intensitaet": 0,
    "Beleuchtungsstaerke": 0,
    "Lautstaerke": 45.2
  },
  "name": "Beucha_Nr1",
  "timestamp": 1743194885
}
```

**Topics f√ºr Wasserstandsdaten:**
```
sensoren/LDDS75_Naunhof_1
```

Beispiel-Nachricht:
```json
{
  "fields": {
    "water_level": 327,
    "meldestufe": 0,
    "water": "Parthe",
    "bat": 3.264
  },
  "name": "LDDS75_Naunhof_1",
  "timestamp": 1743193867
}
```

### 2. REST-API
Ideal f√ºr:
- Webseiten
- Apps
- Datenanalyse
- Historische Daten

**Basis-URL:**
```
https://data.makerspace-partheland.de/
```

**Endpunkte:**
- Alle SenseBox Daten: `/v1/LoRaDevices/senseboxes`
- Spezifische SenseBox: `/v1/LoRaDevices/senseboxes?device=Beucha_Nr1`
- Alle Wasserst√§nde: `/v1/LoRaDevices/waterlevels`
- Spezifischer Wasserstand: `/v1/LoRaDevices/waterlevels?device=LDDS75_Naunhof_1`

## Anwendungsbeispiele

### 1a. Home Assistant Integration
```yaml
mqtt:
  sensor:
    - name: "Au√üentemperatur Beucha"
      state_topic: "senseBox:home/Beucha_Nr1"
      value_template: "{{ value_json.fields.Temperatur }}"
      unit_of_measurement: "¬∞C"
    
    - name: "Luftqualit√§t PM10"
      state_topic: "senseBox:home/Beucha_Nr1"
      value_template: "{{ value_json.fields.PM10 }}"
      unit_of_measurement: "¬µg/m¬≥"

    - name: "Wasserstand Parthe"
      state_topic: "sensoren/LDDS75_Naunhof_1"
      value_template: "{{ value_json.fields.water_level }}"
      unit_of_measurement: "cm"
```

Diese Home Assistant Konfiguration:
1. Erstellt drei MQTT-Sensoren f√ºr verschiedene Messwerte
2. Nutzt die MQTT-Integration von Home Assistant
3. Extrahiert die Werte mittels value_template aus den JSON-Nachrichten
4. Definiert passende Einheiten f√ºr die Anzeige

Sie k√∂nnen die Konfiguration erweitern durch:
- Hinzuf√ºgen weiterer Sensoren (z.B. Luftfeuchte, UV-Intensit√§t)
- Erstellen von Automationen basierend auf den Werten
- Einbinden in Dashboards und Grafiken
- Konfigurieren von Grenzwert-Benachrichtigungen

### 1b. ioBroker Integration
F√ºr die Integration in ioBroker ben√∂tigen Sie den MQTT-Adapter. Hier ein Beispiel f√ºr die Konfiguration:

1. MQTT-Adapter Installation und Konfiguration:
```yaml
Instanz-Einstellungen:
  URL: wss://mqtt.makerspace-partheland.de:443/mqtt
  Websoket: aktiviert
  SSL: aktiviert
  Port: 443
  Path: /mqtt
```

2. MQTT-Subscriptions in der Adapter-Konfiguration:
```
senseBox:home/Beucha_Nr1
sensoren/LDDS75_Naunhof_1
```

3. Beispiel JavaScript f√ºr die Datenverarbeitung (Script-Adapter):
```javascript
// √úberwachung der Sensordaten
on({id: 'mqtt.0.senseBox:home.Beucha_Nr1'}, (obj) => {
    try {
        const data = JSON.parse(obj.state.val);
        
        // Erstelle/Aktualisiere Datenpunkte
        setState('javascript.0.sensoren.beucha.temperatur', {
            val: data.fields.Temperatur,
            ack: true,
            unit: '¬∞C'
        });
        
        setState('javascript.0.sensoren.beucha.luftfeuchte', {
            val: data.fields.Luftfeuchte,
            ack: true,
            unit: '%'
        });
        
        // Berechne Taupunkt
        const taupunkt = taupunktBerechnung(data.fields.Temperatur, data.fields.Luftfeuchte);
        setState('javascript.0.sensoren.beucha.taupunkt', {
            val: taupunkt,
            ack: true,
            unit: '¬∞C'
        });
        
    } catch (e) {
        console.error('Fehler bei der Verarbeitung der SenseBox-Daten: ' + e);
    }
});

// √úberwachung der Wasserstandsdaten
on({id: 'mqtt.0.sensoren.LDDS75_Naunhof_1'}, (obj) => {
    try {
        const data = JSON.parse(obj.state.val);
        
        setState('javascript.0.sensoren.parthe.wasserstand', {
            val: data.fields.water_level,
            ack: true,
            unit: 'cm'
        });
        
        // Batteriewarnung bei niedrigem Stand
        if (data.fields.bat < 3.3) {
            sendTo('telegram.0', {
                text: `‚ö†Ô∏è Batterie niedrig bei ${data.name}: ${data.fields.bat}V`
            });
        }
        
    } catch (e) {
        console.error('Fehler bei der Verarbeitung der Wasserstandsdaten: ' + e);
    }
});

// Hilfsfunktion zur Taupunktberechnung
function taupunktBerechnung(temp, humidity) {
    const a = 17.27;
    const b = 237.7;
    const alpha = ((a * temp) / (b + temp)) + Math.log(humidity/100);
    return (b * alpha) / (a - alpha);
}
```

4. Beispiel f√ºr eine VIS-Ansicht:
```javascript
[{"tpl":"tplValueFloat","data":{"oid":"javascript.0.sensoren.beucha.temperatur","visibility-cond":"==","visibility-val":1,"is_comma":true,"factor":1,"digits":1,"append":"¬∞C","prepend":"Temperatur: "}},
 {"tpl":"tplValueFloat","data":{"oid":"javascript.0.sensoren.beucha.luftfeuchte","visibility-cond":"==","visibility-val":1,"is_comma":true,"factor":1,"digits":1,"append":"%","prepend":"Luftfeuchte: "}},
 {"tpl":"tplValueFloat","data":{"oid":"javascript.0.sensoren.parthe.wasserstand","visibility-cond":"==","visibility-val":1,"is_comma":true,"factor":1,"digits":0,"append":"cm","prepend":"Wasserstand: "}}]
```

Dieses ioBroker-Setup bietet:
1. Automatische MQTT-Verbindung √ºber WebSocket
2. Strukturierte Datenpunkte f√ºr alle Sensormesswerte
3. Berechnete Werte (z.B. Taupunkt)
4. Batterie√ºberwachung mit Telegram-Benachrichtigung
5. Fertige VIS-Widgets zur Anzeige

Sie k√∂nnen die Integration erweitern durch:
- Erstellen von Blockly-Programmen f√ºr weitere Automatisierungen
- Hinzuf√ºgen von Grenzwertalarmen
- Integration in Flot oder Echarts Grafiken
- Verkn√ºpfung mit anderen Adaptern (z.B. Wettervorhersage)
- Erstellung eigener VIS-Widgets
- Export der Daten in Influx/SQL-Datenbanken

### 2. Node-RED Flow f√ºr Gew√§ssermonitoring
```json
[
    {
        "id": "mqtt-in",
        "type": "mqtt in",
        "topic": "sensoren/LDDS75_Naunhof_1",
        "mqtt": {
            "server": "wss://mqtt.makerspace-partheland.de:443/mqtt"
        },
        "wires": [["json-parse"]]
    },
    {
        "id": "json-parse",
        "type": "json",
        "wires": [["store-data"]]
    },
    {
        "id": "store-data",
        "type": "function",
        "name": "Speichere Messwerte",
        "func": "// Speichere die letzten 12 Messwerte (2 Stunden)\nconst maxLength = 12;\n\n// Hole gespeicherte Werte oder initialisiere Array\nflow.measurements = flow.measurements || [];\n\n// F√ºge neuen Messwert hinzu\nflow.measurements.push({\n    timestamp: Date.now(),\n    value: msg.payload.fields.water_level\n});\n\n// Behalte nur die letzten X Messungen\nif (flow.measurements.length > maxLength) {\n    flow.measurements.shift();\n}\n\n// Berechne Trend\nif (flow.measurements.length >= 2) {\n    const oldest = flow.measurements[0].value;\n    const newest = flow.measurements[flow.measurements.length - 1].value;\n    const trend = newest - oldest;\n    \n    msg.trend = trend;\n    msg.trendPercent = (trend / oldest * 100).toFixed(1);\n    msg.currentValue = newest;\n    \n    return msg;\n}\n\nreturn null;",
        "wires": [["check-trend"]]
    },
    {
        "id": "check-trend",
        "type": "switch",
        "name": "Pr√ºfe Trend",
        "rules": [
            {
                "t": "gt",
                "v": "5",
                "vt": "num"
            },
            {
                "t": "lt",
                "v": "-5",
                "vt": "num"
            }
        ],
        "wires": [["create-message"], ["create-message"]]
    },
    {
        "id": "create-message",
        "type": "template",
        "name": "Erstelle Nachricht",
        "template": "Wasserstands√§nderung: {{ payload.trendPercent }}%\nAktueller Stand: {{ payload.currentValue }} cm",
        "wires": [["notify"]]
    },
    {
        "id": "notify",
        "type": "debug",
        "name": "Ausgabe",
        "active": true,
        "complete": "payload"
    }
]
```

Dieser Flow:
1. Empf√§ngt MQTT-Nachrichten vom Wasserstandssensor
2. Wandelt die JSON-Daten in ein Objekt um
3. Speichert die letzten 12 Messwerte (2 Stunden bei 10-Minuten-Intervallen)
4. Berechnet den Trend √ºber diesen Zeitraum
5. Benachrichtigt bei √Ñnderungen √ºber 5% (kann an Debug-Node oder Benachrichtigungsdienst angeschlossen werden)

Sie k√∂nnen den Flow anpassen durch:
- √Ñndern der `maxLength` f√ºr l√§ngere/k√ºrzere Beobachtungszeitr√§ume
- Anpassen der Schwellwerte in der Switch-Node (aktuell 5/-5)
- Ersetzen der Debug-Node durch Email, Telegram, Push-Benachrichtigungen etc.

### 3. Python-Script f√ºr Gew√§sseranalyse
```python
import requests
import pandas as pd
from datetime import datetime, timedelta

# Abruf der Wasserstandsdaten
response = requests.get('https://data.makerspace-partheland.de/v1/LoRaDevices/waterlevels?device=LDDS75_Naunhof_1')
data = response.json()

# Daten in DataFrame umwandeln
df = pd.DataFrame({
    'Wasserstand': [data['features'][0]['properties']['fields']['water_level']],
    'Zeitstempel': [datetime.fromtimestamp(data['features'][0]['properties']['lastSeen'])],
    'Gew√§sser': [data['features'][0]['properties']['fields']['water']]
})

# Analyse
print(f"Aktueller Wasserstand {df['Gew√§sser'][0]}: {df['Wasserstand'][0]} cm")
print(f"Letzte Messung: {df['Zeitstempel'][0].strftime('%d.%m.%Y %H:%M')}")
```

Dieses Python-Script:
1. Nutzt die REST-API zum Abrufen der Wasserstandsdaten
2. Konvertiert die Unix-Timestamps in lesbare Zeitstempel
3. Strukturiert die Daten in einem Pandas DataFrame f√ºr weitere Analysen
4. Gibt eine formatierte Zusammenfassung aus

Sie k√∂nnen das Script erweitern durch:
- Abrufen historischer Daten f√ºr Trendanalysen
- Erstellen von Matplotlib/Seaborn Visualisierungen
- Export der Daten in CSV/Excel f√ºr weitere Verarbeitung
- Implementierung von statistischen Analysen
- Kombination mit Wetterdaten f√ºr Korrelationsanalysen

### 4. Schulprojekt: Gew√§sser√∂kologie
```javascript
// HTML + Chart.js
const ctx = document.getElementById('wasserstandChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Wasserstand Parthe',
            data: [],
            borderColor: 'rgb(54, 162, 235)',
            tension: 0.1
        }]
    },
    options: {
        scales: {
            y: {
                title: {
                    display: true,
                    text: 'Wasserstand (cm)'
                }
            }
        }
    }
});

// MQTT Verbindung
const client = mqtt.connect('wss://mqtt.makerspace-partheland.de:443/mqtt');
client.subscribe('sensoren/LDDS75_Naunhof_1');

client.on('message', (topic, message) => {
    const data = JSON.parse(message);
    const zeit = new Date().toLocaleTimeString();
    
    // F√ºge neue Daten hinzu
    chart.data.labels.push(zeit);
    chart.data.datasets[0].data.push(data.fields.water_level);
    
    // Behalte nur die letzten 24 Stunden
    if (chart.data.labels.length > 288) { // 24h * 12 Messungen/Stunde
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    
    chart.update();
});
```

Dieses JavaScript-Beispiel:
1. Erstellt ein interaktives Liniendiagramm mit Chart.js
2. Verbindet sich √ºber WebSocket mit dem MQTT-Broker
3. Aktualisiert das Diagramm in Echtzeit mit neuen Messwerten
4. Beh√§lt einen 24-Stunden-Verlauf bei (288 Messpunkte)
5. Formatiert die Zeitachse automatisch

Sie k√∂nnen das Beispiel erweitern durch:
- Hinzuf√ºgen mehrerer Datens√§tze (z.B. verschiedene Messstellen)
- Implementierung von Zoom- und Pan-Funktionen
- Export der Daten als CSV oder Bild
- Anzeige von Minimum/Maximum/Durchschnittswerten
- Hinzuf√ºgen von Schwellwert-Markierungen
- Integration in eine gr√∂√üere Webapplikation

Ben√∂tigte HTML-Struktur:
```html
<canvas id="wasserstandChart"></canvas>

<!-- Erforderliche Bibliotheken -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
```

## Anwendungsideen f√ºr Wasserstandsdaten

### Umweltbildung
- üìö Langzeitbeobachtung von Gew√§ssern
- üå± Zusammenhang zwischen Niederschlag und Wasserstand
- üîç Einfluss der Jahreszeiten auf Gew√§sser

### Gew√§ssermanagement
- üìä Pegelstands√ºberwachung
- üíß Wasserressourcenmanagement
- üåø √ñkologische Durchg√§ngigkeit

### Freizeitaktivit√§ten
- üö£ Wassersport (Kanu, Rudern)
- üé£ Angelsport
- üèä Badegew√§sser

### Wissenschaft & Forschung
- üìà Langzeitstudien
- üåç Klimawandelauswirkungen
- üíß Grundwasserspiegel-Korrelation

## Technische Details

### Datenaktualisierung
- SenseBox Daten: Alle 1-5 Minuten
- Wasserstandsdaten: Alle 15-30 Minuten

### Datenformate
- Alle Zeitstempel sind Unix-Timestamps (Sekunden seit 1970)
- Temperatur in ¬∞C
- Luftfeuchte in %
- Luftdruck in hPa
- Feinstaub in ¬µg/m¬≥
- Wasserstand in cm
- UV-Intensit√§t in mW/m¬≤
- Lautst√§rke in dB

### Fehlerbehebung
1. Keine MQTT-Verbindung:
   - √úberpr√ºfen Sie die WebSocket-URL
   - Stellen Sie sicher, dass SSL/TLS aktiviert ist

2. Keine Daten:
   - √úberpr√ºfen Sie das Topic-Format
   - Pr√ºfen Sie die Zeitstempel der letzten Nachricht